{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "signals": [
    {
      "name": "direction",
      "update": "data('current-stats')[0].location"
    }
  ],
  "data": [
    {
      "name": "current-stats",
      "url": {
        "%context%": true,
        "%timefield%": "timestamp",
        "index": "current-stats",
        "body": {
          "size": 1,
          "sort": [{"timestamp": {"order": "desc"}}],
          "_source": ["location", "speed"]
        }
      },
      "format": {"property": "hits.hits"},
      "transform": [
        {
          "type": "formula",
          "as": "location",
          "expr": "datum._source.location"
        },
        {
          "type": "formula",
          "as": "speed",
          "expr": "round(datum._source.speed * 10000) / 10000"
        }
      ]
    },
    {
      "name": "directions",
      "values": [
        {"label": "N", "index": 0},
        {"label": "NE", "index": 1},
        {"label": "E", "index": 2},
        {"label": "SE", "index": 3},
        {"label": "S", "index": 4},
        {"label": "SW", "index": 5},
        {"label": "W", "index": 6},
        {"label": "NW", "index": 7}
      ],
      "transform": [
        {
          "type": "formula",
          "as": "startAngle",
          "expr": "datum.index * 45"
        },
        {
          "type": "formula",
          "as": "endAngle",
          "expr": "(datum.index + 1) * 45"
        },
        {
          "type": "formula",
          "as": "x",
          "expr": "cos(datum.startAngle * PI / 180) * 100"
        },
        {
          "type": "formula",
          "as": "y",
          "expr": "sin(datum.startAngle * PI / 180) * 100"
        }
      ]
    }
  ],
  "marks": [
    {
      "type": "group",
      "encode": {
        "enter": {
          "x": {"value": 100},
          "y": {"value": 50}
        }
      },
      "marks": [
        {
          "type": "text",
          "encode": {
            "enter": {
              "x": {"value": 100},
              "y": {"value": -30},
              "text": {"value": "Direction"},
              "align": {"value": "center"},
              "baseline": {"value": "middle"},
              "fontSize": {"value": 20},
              "fill": {"value": "blue"}
            }
          }
        },
        {
          "type": "group",
          "encode": {
            "enter": {
              "x": {"value": 100},
              "y": {"value": 150}
            }
          },
          "marks": [
            {
              "type": "arc",
              "from": {"data": "directions"},
              "encode": {
                "enter": {
                  "x": {"value": 0},
                  "y": {"value": 0},
                  "startAngle": {"field": "startAngle"},
                  "endAngle": {"field": "endAngle"},
                  "innerRadius": {"value": 80},
                  "outerRadius": {"value": 90},
                  "fill": {"value": "gray"}
                }
              }
            },
            {
              "type": "text",
              "from": {"data": "directions"},
              "encode": {
                "enter": {
                  "x": {"field": "x"},
                  "y": {"field": "y"},
                  "text": {"field": "label"},
                  "align": {"value": "center"},
                  "baseline": {"value": "middle"},
                  "fontSize": {"value": 14},
                  "fill": {"value": "black"}
                }
              }
            },
            {
              "type": "path",
              "encode": {
                "enter": {
                  "x": {"value": 0},
                  "y": {"value": 0},
                  "path": {"signal": "'M0,-70L-5,-60L5,-60Z'"},
                  "fill": {"value": "red"}
                },
                "update": {
                  "rotate": {"signal": "direction"}
                }
              }
            }
          ]
        }
      ]
    },
    {
      "type": "group",
      "encode": {
        "enter": {
          "x": {"value": 400},
          "y": {"value": 50}
        }
      },
      "marks": [
        {
          "type": "text",
          "encode": {
            "enter": {
              "x": {"value": 100},
              "y": {"value": -30},
              "text": {"value": "Speed"},
              "align": {"value": "center"},
              "baseline": {"value": "middle"},
              "fontSize": {"value": 20},
              "fill": {"value": "green"}
            }
          }
        },
        {
          "type": "text",
          "encode": {
            "enter": {
              "x": {"value": 100},
              "y": {"value": 150},
              "text": {"signal": "data('current-stats')[0].speed + ' km/h'"},
              "align": {"value": "center"},
              "baseline": {"value": "middle"},
              "fontSize": {"value": 20},
              "fill": {"value": "black"}
            }
          }
        }
      ]
    }
  ]
}
